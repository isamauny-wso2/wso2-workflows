name: Release WSO2 APIM Policy Repository

on:
  workflow_call: {}

env:
  GIT_ORG: wso2-cicd
  GIT_CICD_REPO: wso2-pipeline
  GIT_CD_BRANCH: dev
  INITIAL_VERSION: v1.0
  MAX_MINOR_VERSION: 9
  GIT_BOT_USERNAME: ${{ secrets.WSO2_GIT_BOT_USERNAME }}
  GIT_BOT_EMAIL: ${{ secrets.WSO2_GIT_BOT_EMAIL }}
  GIT_BOT_PAT: ${{ secrets.WSO2_GIT_BOT_PAT }}
       
jobs:
  release_apim_policy:
    name: Release WSO2 APIM Policy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 5

      - name: Extract repository name
        run: echo "CURRENT_REPO_NAME=$(echo $GITHUB_REPOSITORY | cut -d '/' -f 2)" >> $GITHUB_ENV

      - name: Fetch PR metadata
        uses: 8BitJonny/gh-get-current-pr@2.1.3
        id: pr

      - name: Zip src folder under repo name
        run: |
          mkdir -p $CURRENT_REPO_NAME
          mv src $CURRENT_REPO_NAME/
          zip -r $CURRENT_REPO_NAME.zip  $CURRENT_REPO_NAME/src

      - name: Create GitHub Release
        id: release
        run: |
          echo "${{ env.GIT_BOT_PAT }}" | gh auth login --with-token
          currentVersion=$(gh release view --repo $GITHUB_REPOSITORY --json tagName --jq '.tagName' || true)

          if [ -z $currentVersion ]; then
            newVersion=${{env.INITIAL_VERSION}}
          else
            major=$(echo $currentVersion | cut -d '.' -f 1 | tr -d 'v')
            minor=$(echo $currentVersion | cut -d '.' -f 2)

            ((++minor))
            if [ $minor -gt ${{env.MAX_MINOR_VERSION}} ]; then
                minor=0
                ((++major))
            fi

            newVersion="v${major}.${minor}"
          fi
          
          echo "New version: $newVersion"

          releaseNotes="Release notes for version $newVersion
          - Pull Request Title: ${{steps.pr.outputs.pr_title}}
          - Pull Request: ${{steps.pr.outputs.pr_url}}
          - Pull Request Merged At: ${{steps.pr.outputs.pr_merged_at}}
          "

          # Release the Packs
          gh release create $newVersion --title "$CURRENT_REPO_NAME - $newVersion" --notes "$releaseNotes"

          # Release the APIM Pack
          gh release upload $newVersion  $CURRENT_REPO_NAME.zip
          
          echo "NEW_VERSION=$newVersion" >> $GITHUB_OUTPUT

      - name: Update Central CD Config
        run: |
          mkdir apim-cd
          cd apim-cd

          git config --global user.email "${{ env.GIT_BOT_EMAIL }}"
          git config --global user.name "${{env.GIT_BOT_USERNAME}}"
          git clone https://${{env.GIT_BOT_USERNAME}}:${{ env.GIT_BOT_PAT }}@github.com/${{env.GIT_ORG}}/${{env.GIT_CICD_REPO}} --branch ${{env.GIT_CD_BRANCH}} --single-branch
          
          cd ${{env.GIT_CICD_REPO}}

          releaseFilePath="apim/policies/mediation/$CURRENT_REPO_NAME/release.json"
          releaseFile=$releaseFilePath

          newVersion=${{steps.release.outputs.NEW_VERSION}}

          # Read the JSON file and update the details
          updatedReleaseFile=$(jq '
              .releaseVersion = "'"$newVersion"'" |
              .pullRequest.url = "'"${{steps.pr.outputs.pr_url}}"'" |
              .pullRequest.title = "'"${{steps.pr.outputs.pr_title}}"'" |
              .pullRequest.mergedAt = "'"${{steps.pr.outputs.pr_merged_at}}"'"
            ' "$releaseFile")

          echo "$updatedReleaseFile" > "$releaseFile"

          git add "$releaseFilePath"
          git commit -m "[CD] [Dev] [APIM-Policy] [$CURRENT_REPO_NAME] [$newVersion]"
          git push origin ${{env.GIT_CD_BRANCH}}
